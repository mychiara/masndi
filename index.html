<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Meta tag akan diisi oleh server, ini hanya fallback -->
    <title>Masandigital.com</title> 
    <meta name="description" content="A personal blog about technology, design, and life adventures—told through inspiring stories and stunning visuals. Explore ideas, works, and journeys.">
    
    <meta name="google-site-verification" content="4iOW_hDD8B-IRUAm7keHj2sZFwbLoXV_jQCJV-4CWsY" />
    <meta name="google-site-verification" content="QV9FBw9pHOPWT746Ft1PLsRHIv-2KZwr0dAOEt6YmYQ" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <?!= HtmlService.createHtmlOutputFromFile('styles').getContent() ?>

</head>
<body>
    <!-- ====== HEADER ====== -->
    <header class="site-header">
        <div class="container">
            <div class="logo">
                <a href="<?= domain ?>">Masandigital.com</a>
            </div>
            <nav class="main-nav">
                <ul id="main-nav-list">
                    <li><a href="<?= domain ?>" class="<?== pageType === 'list' && !currentFilter.value ? 'active' : '' ?>">Home</a></li>
                    <!-- Navigasi statis lainnya bisa ditambahkan di sini -->
                    <li><a href="#">About</a></li>
                    <li><a href="#">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- ====== MAIN WRAPPER (Konten + Sidebar) ====== -->
    <div class="main-wrapper container">

        <!-- ====== KONTEN UTAMA ====== -->
        <main class="content-area">
            
            <? if (pageType === 'list') { ?>
            <div id="homepage-view">
                <section class="hero-section">
                    <h1 class="hero-title">Where Ideas Begin, and Inspiration Never Ends</h1>
                    <p class="hero-subtitle">A personal blog about technology, design, and life adventures—wrapped in stunning and immersive visuals.</p>
                    <div class="hero-search">
                         <form id="search-form" role="search" action="<?= domain ?>" method="get">
                            <input type="search" name="search" id="search-input" placeholder="Explore the content that sparks your curiosity..." required>
                        </form>
                    </div>
                </section>

                <h2 class="page-title" id="page-title"><?!= pageHeading ?></h2>
                <div id="article-list-grid">
                  <? if (articleData.articles && articleData.articles.length > 0) { ?>
                    <? for (var i = 0; i < articleData.articles.length; i++) { var article = articleData.articles[i]; ?>
                      <article class="article-card glass-effect">
                          <div class="card-image">
                              <a href="?id=<?= article.id ?>"><img src="<?= article.gambar_fitur || 'https://images.unsplash.com/photo-1517694712202-14dd9538aa97?auto=format&fit=crop&w=800&q=60' ?>" alt="<?= article.judul ?>" loading="lazy" width="400" height="220"></a>
                              <span class="card-category"><?= article.kategori || 'Umum' ?></span>
                          </div>
                          <div class="card-content">
                              <h2 class="card-title"><a href="?id=<?= article.id ?>"><?= article.judul ?></a></h2>
                              <p class="card-excerpt"><?= article.cuplikan || 'Klik untuk membaca selengkapnya...' ?></p>
                              <div class="card-meta">
                                  <span><i class="fa-solid fa-user"></i> <?= article.penulis ?></span>
                                  <span><i class="fa-solid fa-calendar-days"></i> <?= article.tanggal_publikasi ?></span>
                              </div>
                          </div>
                      </article>
                    <? } ?>
                  <? } else { ?>
                      <div style="grid-column: 1 / -1; text-align: center;"><h2>Tidak Ada Hasil</h2><p>Belum ada artikel yang cocok dengan kriteria Anda.</p></div>
                  <? } ?>
                </div>
                <div id="load-more-container" style="<?= articleData.currentPage < articleData.totalPages ? 'display:block;' : 'display:none;' ?>">
                    <button id="load-more-btn">Load More Articles</button>
                </div>
            </div>
            <? } ?>

            <? if (pageType === 'single') { ?>
            <div id="single-article-view">
                <article id="article-container" class="single-article glass-effect">
                    <? if (article.gambar_fitur) { ?>
                      <img src="<?= article.gambar_fitur ?>" alt="<?= article.judul ?>" class="article-featured-image" loading="eager">
                    <? } ?>
                    <h1 class="article-title"><?= article.judul ?></h1>
                    <div class="meta">
                        <span><i class="fa-solid fa-user"></i> <?= article.penulis ?></span>
                        <span><i class="fa-solid fa-calendar-days"></i> <?= article.tanggal_publikasi ?></span>
                        <? if (article.kategori) { ?>
                          <span><i class="fa-solid fa-tag"></i> <?= article.kategori ?></span>
                        <? } ?>
                    </div>
                    <div id="toc-container" class="toc-container glass-effect" style="display:none;"></div>
                    <div id="article-content-wrapper" class="article-content"><?!= article.konten ?></div>
                    <div id="social-share-container" class="social-share-container" style="display:none;"></div>
                </article>

                <? if (article.relatedArticles && article.relatedArticles.length > 0) { ?>
                <section id="related-posts">
                    <h2 class="related-posts-title">Read Also</h2>
                    <div id="related-posts-grid">
                       <? for (var i = 0; i < article.relatedArticles.length; i++) { var related = article.relatedArticles[i]; ?>
                        <article class="article-card glass-effect">
                          <div class="card-image"><a href="?id=<?= related.id ?>"><img src="<?= related.gambar_fitur || 'https://images.unsplash.com/photo-1486312338219-ce68d2c6f44d?auto=format&fit=crop&w=800&q=60' ?>" alt="<?= related.judul ?>" loading="lazy" width="400" height="160"></a><span class="card-category"><?= related.kategori || 'Umum' ?></span></div>
                          <div class="card-content"><h3 class="card-title" style="font-size: 1.2rem;"><a href="?id=<?= related.id ?>"><?= related.judul ?></a></h3></div>
                        </article>
                       <? } ?>
                    </div>
                </section>
                <? } ?>

                <nav class="article-navigation" id="article-nav">
                    <a href="?id=<?= article.prevId ?>" class="nav-button prev" id="nav-prev" style="<?= article.prevId ? 'visibility: visible;' : 'visibility: hidden;' ?>"><i class="fa-solid fa-arrow-left"></i> <span>Sebelumnya</span></a>
                    <a href="<?= domain ?>" class="nav-button home"><i class="fa-solid fa-house"></i> <span>Beranda</span></a>
                    <a href="?id=<?= article.nextId ?>" class="nav-button next" id="nav-next" style="<?= article.nextId ? 'visibility: visible;' : 'visibility: hidden;' ?>"><span>Selanjutnya</span> <i class="fa-solid fa-arrow-right"></i></a>
                </nav>
            </div>
            <? } ?>
            
            <!-- Elemen loading & error sekarang hanya untuk interaksi JS, bukan load awal -->
            <div id="loading" style="display:none;"><div class="spinner"></div><p>Memuat...</p></div>
            <div id="error" style="display:none;"></div>
        </main>

        <!-- ====== SIDEBAR ====== -->
        <aside class="sidebar">
            <div class="widget glass-effect">
                <h3 class="widget-title">About Me</h3>
                <img src="https://masandigital.com/assets/images/author-photo.jpeg" alt="Foto profil" class="profile-pic" onerror="this.style.display='none'">
                <p>Welcome! This blog is my personal space to share ideas about technology, design, and life adventures. I hope you find it useful and inspiring!</p>
            </div>
            <div class="widget glass-effect">
                <h3 class="widget-title">Categories</h3>
                <ul class="category-list" id="sidebar-category-list">
                    <? if (siteData && siteData.categories && siteData.categories.length > 0) { ?>
                      <? for (var i = 0; i < siteData.categories.length; i++) { var category = siteData.categories[i]; ?>
                        <li><a href="?kategori=<?= encodeURIComponent(category) ?>"><?= category ?></a></li>
                      <? } ?>
                    <? } else { ?>
                      <li>Tidak ada kategori.</li>
                    <? } ?>
                </ul>
            </div>
            <div class="widget glass-effect">
                <h3 class="widget-title">Latest Articles</h3>
                <ul class="category-list" id="recent-posts-list">
                   <? if (siteData && siteData.recentPosts && siteData.recentPosts.length > 0) { ?>
                      <? for (var i = 0; i < siteData.recentPosts.length; i++) { var post = siteData.recentPosts[i]; ?>
                        <li><a href="?id=<?= post.id ?>"><?= post.judul ?></a></li>
                      <? } ?>
                    <? } else { ?>
                      <li>Tidak ada artikel.</li>
                    <? } ?>
                </ul>
            </div>
        </aside>
    </div>

    <!-- ====== FOOTER ====== -->
    <footer class="site-footer">
        <div class="container">
             <div class="footer-widgets">
                <!-- widget-widget -->
             </div>
            <div class="copyright">
                <p>© 2024 Masandigital.com.❤.</p>
            </div>
        </div>
    </footer>

    <script>
        // ===================================================================
        // PENGATURAN CLIENT-SIDE (setelah render server)
        // ===================================================================
        const API_URL = "https://script.google.com/macros/s/AKfycbw4TFklzKMpxSx6KRCaw_iMbIaFh5WFCIuFIxyVFh1e1rZm58AefkNB0y1dYHXd40cpqg/exec"; // Disuntik dari server
        const MY_DOMAIN = "<?= domain ?>";
        const BASE_PATH = MY_DOMAIN;
        
        // State awal disuntik dari server
        let currentPage = <?= pageType === 'list' ? articleData.currentPage : 1 ?>;
        let totalPages = <?= pageType === 'list' ? articleData.totalPages : 1 ?>;
        let isLoading = false;
        let currentFilter = <?= pageType === 'list' ? currentFilter : 'null' ?>;

        document.addEventListener("DOMContentLoaded", () => {
            initializeDynamicElements();
        });

        function initializeDynamicElements() {
            // Fungsionalitas yang masih butuh JS setelah halaman dimuat
            if (document.getElementById('load-more-btn')) {
                document.getElementById('load-more-btn').addEventListener('click', () => {
                    if (currentPage < totalPages && !isLoading) {
                        currentPage++;
                        loadMoreArticles(currentPage, currentFilter);
                    }
                });
            }

            if (document.getElementById('article-content-wrapper')) {
                generateTOC();
                generateSocialShareLinks();
            }
        }
        
        async function loadMoreArticles(page, filter = null) {
            if (isLoading) return;
            isLoading = true;

            const loadMoreBtn = document.getElementById('load-more-btn');
            loadMoreBtn.textContent = 'Memuat...';
            loadMoreBtn.disabled = true;
            
            let queryParams = `action=getArticles&page=${page}&limit=5&domain=${encodeURIComponent(MY_DOMAIN)}`;
            if (filter && filter.value) {
                if (filter.type === 'category') queryParams += `&kategori=${encodeURIComponent(filter.value)}`;
                else if (filter.type === 'search') queryParams += `&search=${encodeURIComponent(filter.value)}`;
            }
            
            try {
                const response = await fetch(`${API_URL}?${queryParams}`);
                if (!response.ok) throw new Error("Gagal mengambil data tambahan!");
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                appendArticles(data.articles);
                currentPage = data.currentPage;
                totalPages = data.totalPages;

                if (currentPage >= totalPages) {
                    document.getElementById('load-more-container').style.display = 'none';
                }

            } catch (error) {
                console.error("Gagal memuat lebih banyak artikel:", error);
                alert("Gagal memuat lebih banyak artikel.");
            } finally {
                isLoading = false;
                loadMoreBtn.textContent = 'Load More Articles';
                loadMoreBtn.disabled = false;
            }
        }
        
        function appendArticles(articles) {
            const container = document.getElementById("article-list-grid");
            if (!articles || articles.length === 0) return;

            const articlesHtml = articles.map(article => {
                const articleUrl = `?id=${article.id}`;
                const imageUrl = article.gambar_fitur || 'https://images.unsplash.com/photo-1517694712202-14dd9538aa97?auto=format&fit=crop&w=800&q=60';
                return `
                    <article class="article-card glass-effect">
                        <div class="card-image">
                            <a href="${articleUrl}"><img src="${imageUrl}" alt="${article.judul}" loading="lazy" width="400" height="220"></a>
                            <span class="card-category">${article.kategori || 'Umum'}</span>
                        </div>
                        <div class="card-content">
                            <h2 class="card-title"><a href="${articleUrl}">${article.judul}</a></h2>
                            <p class="card-excerpt">${article.cuplikan || 'Klik untuk membaca selengkapnya...'}</p>
                            <div class="card-meta">
                                <span><i class="fa-solid fa-user"></i> ${article.penulis}</span>
                                <span><i class="fa-solid fa-calendar-days"></i> ${article.tanggal_publikasi}</span>
                            </div>
                        </div>
                    </article>`;
            }).join('');
            
            container.insertAdjacentHTML('beforeend', articlesHtml);
        }

        // --- Fungsi Helper untuk Halaman Artikel ---
        function generateTOC() { /* Fungsi ini tetap sama, tidak perlu diubah */ }
        function generateSocialShareLinks() { /* Fungsi ini tetap sama, tidak perlu diubah */ }
        
        // (Salin fungsi generateTOC dan generateSocialShareLinks dari kode lama Anda ke sini)
         function generateTOC() {
            const contentWrapper = document.getElementById('article-content-wrapper'); const tocContainer = document.getElementById('toc-container');
            if (!contentWrapper || !tocContainer) return; const headings = contentWrapper.querySelectorAll('h2, h3'); if (headings.length < 2) { tocContainer.style.display = 'none'; return; }
            let tocHTML = '<p class="toc-title"><i class="fa-solid fa-list-ol"></i> Daftar Isi</p><ul id="toc-list" class="toc-list">';
            headings.forEach((heading, index) => { const id = 'heading-' + index; heading.id = id; const levelClass = heading.tagName === 'H3' ? 'class="toc-h3"' : ''; tocHTML += `<li ${levelClass}><a href="#${id}">${heading.textContent}</a></li>`; });
            tocHTML += '</ul>';
            tocContainer.innerHTML = tocHTML;
            tocContainer.style.display = 'block';
        }
         function generateSocialShareLinks() {
            const container = document.getElementById('social-share-container'); if (!container) return;
            const articleUrl = encodeURIComponent(window.location.href); 
            const articleTitle = encodeURIComponent(document.querySelector('.article-title').textContent);
            const shareLinks = {
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${articleUrl}`,
                twitter: `https://twitter.com/intent/tweet?url=${articleUrl}&text=${articleTitle}`,
                linkedin: `https://www.linkedin.com/shareArticle?mini=true&url=${articleUrl}&title=${articleTitle}`,
                whatsapp: `https://api.whatsapp.com/send?text=${articleTitle}%20${articleUrl}`,
                email: `mailto:?subject=${articleTitle}&body=Check%20out%20this%20article:%20${articleUrl}`
            };
            container.innerHTML = `<h3 class="social-share-title">Share this article</h3><div class="social-share-buttons"><a href="${shareLinks.facebook}" target="_blank" rel="noopener noreferrer" class="share-facebook" aria-label="Bagikan ke Facebook"><i class="fab fa-facebook-f"></i></a><a href="${shareLinks.twitter}" target="_blank" rel="noopener noreferrer" class="share-twitter" aria-label="Bagikan ke Twitter"><i class="fab fa-twitter"></i></a><a href="${shareLinks.linkedin}" target="_blank" rel="noopener noreferrer" class="share-linkedin" aria-label="Bagikan ke LinkedIn"><i class="fab fa-linkedin-in"></i></a><a href="${shareLinks.whatsapp}" target="_blank" rel="noopener noreferrer" class="share-whatsapp" aria-label="Bagikan ke WhatsApp"><i class="fab fa-whatsapp"></i></a><a href="${shareLinks.email}" class="share-email" aria-label="Bagikan via Email"><i class="fas fa-envelope"></i></a></div>`;
            container.style.display = 'block';
        }

    </script>
</body>
</html>
